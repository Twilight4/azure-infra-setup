* Table of Contents :toc:
- [[#steps-to-deploy][Steps to deploy]]
  - [[#prerequisites][Prerequisites]]
  - [[#authenticate-with-azure][Authenticate with Azure]]
  - [[#create-terraform-state-backend][Create Terraform State Backend]]
  - [[#deploy-the-infrastructure][Deploy the infrastructure]]
  - [[#verify-deployment][Verify deployment]]
  - [[#clean-up][Clean up]]
- [[#roadmap-wip][Roadmap WIP]]

* Steps to deploy
** Prerequisites
- Azure subscription (Owner or Contributor role)
- Azure CLI installed (az)
- Terraform installed (terraform)
- Git

** Authenticate with Azure
Service principal is safer for CI/CD, but interactive login is fine for learning.

**** Option A — Interactive login (simplest)
#+begin_src shell
# Your Azure CLI will use your logged-in account for Terraform
az login
#+end_src

**** Option B — Service Principal (recommended for automation)
#+begin_src shell
# Create a service principal (replace <subscription-id>)
az ad sp create-for-rbac --name "tf-sp-learning" --role Contributor --scopes /subscriptions/<subscription-id>

# Verify the created service principal
az ad sp list --display-name tf-sp-learning -o table

# To see more details for tf-sp-learning (The secret can't be viewed again)
az ad sp list --display-name tf-sp-learning -o json | jq

# Note the output
{
  "appId": "...",
  "password": "...",
  "tenant": "..."
}

# Set environment variables for Terraform
# If you use interactive login, these are not strictly needed, but required if using SP
export ARM_CLIENT_ID="<appId>"
export ARM_CLIENT_SECRET="<password>"
export ARM_TENANT_ID="<tenant>"

# To list subscription ids
az account list -o table

# To check subscription-id
az account show --query id -o tsv

# Export subscription ID
export ARM_SUBSCRIPTION_ID="<subscription-id>"

# Log in to service principal
az logout
az login --service-principal \
  -u <appId> -p <password> --tenant <tenantId>
#+end_src

** Create Terraform State Backend
Terraform needs a remote backend to store its state.

#+begin_src shell
# Modify the variables of backend.sh script and run the script
./backend.sh
#+end_src

Then update =global/backend.tf= to point at this container.
#+begin_src tf
resource_group_name  = "rg-tfstate"
storage_account_name = "tfstatestorage4123"
container_name       = "tfstate"
key                  = "dev.terraform.tfstate"
#+end_src

** Deploy the infrastructure
#+begin_src shell
# Initialize Terraform (If you changed backend settings, you need to run terraform init -reconfigure)
terraform init -reconfigure

# Preview changes
terraform plan -var-file=dev.tfvars

# Apply changes - this will create all resources
terraform apply -var-file=dev.tfvars
#+end_src

** Verify deployment
**** Using Azure Portal
- Go to [[https://portal.azure.com/][portal.azure.com]]
- Navigate to =Resource Groups= → select your environment group (e.g., =rg-dev=)
- Verify the resources exist

**** Using Azure CLI
#+begin_src shell
# check the resource group and resources
az group list -o table

# Show storage account for the resource group
az storage account list -g rg-tfstate -o table
#+end_src

** Clean up
#+begin_src shell
# Remove all terraform resources and avoid charges
terraform destroy -var-file=dev.tfvars

# Remove service principal named tf-sp-learning (if created)
az ad sp delete --id tf-sp-learning

# Remove a blob container for terraform state named tfstatestorage4123
az storage container delete \
  --name tfstatestorage4123 \
  --account-name tfstatestorage4123

# Remove storage account for that rg-tfstate resource group named tfstatestorage4123
az storage account delete \
  --name tfstatestorage4123 \
  --resource-group rg-tfstate \
  --yes

# Remove a resource group named rg-tfstate
az group delete \
  --name rg-tfstate \
  --yes --no-wait
#+end_src

* Roadmap WIP
- [ ] Use Azure Key Vault to provide secrets (DB password, etc.) and do not store secrets in git or =.tfvars= checked into source.
