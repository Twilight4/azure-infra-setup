* Azure 3-layer Terraform
This repo demonstrates a secure, scalable three-layer (web/app/db) Azure architecture using Terraform modules. It follows hub-and-spoke network pattern, central security services (Azure Firewall + NSGs), managed DBs with private network access, and scaleable compute.


* Repository layout
#+begin_src shell
azure-three-layer-terraform/
├── README.md
├── environments/
│ ├── dev.tfvars
│ └── prod.tfvars
├── global/ # global infra (resource groups for shared services, backends)
│ ├── backend.tf
│ └── providers.tf
├── modules/
│ ├── network/
│ │ ├── main.tf
│ │ ├── variables.tf
│ │ └── outputs.tf
│ ├── security/
│ │ ├── main.tf
│ │ ├── variables.tf
│ │ └── outputs.tf
│ ├── compute/
│ │ ├── main.tf
│ │ ├── variables.tf
│ │ └── outputs.tf
│ └── db/
│ ├── main.tf
│ ├── variables.tf
│ └── outputs.tf
├── staging/ # example environment that composes modules
│ ├── main.tf
│ ├── variables.tf
│ └── outputs.tf
└── versions.tf
#+end_src


* Project overview
** Repo
- Modular layout with these modules:
  + *network* — hub-and-spoke VNet(s), peering, NAT/route table hooks
  + *security* — Azure Firewall, NSGs, route tables, basic Key Vault wiring
  + *compute* — VM Scale Set example (can be swapped for AKS) and hooks for autoscale
  + *db* — managed DB (MySQL shown) with private access and firewall rule example
- Root environment example (staging) that composes the modules.
- Remote-state backend example using *azurerm* storage account.

** Architecture overview (three-layer, Azure-focused)
- Presentation (web) layer in its own spoke VNet/subnet, fronted by Application Gateway (WAF) or public LB.
- Application (app) layer in a separate spoke — hosts app server VMSS or AKS.
- Data (db) layer in its own spoke containing managed DB services (Azure Database for PostgreSQL / MySQL / SQL) with =public_network_access_enabled = false= so only private connectivity is allowed.
- Shared Hub VNet contains central services: Azure Firewall, VPN/ExpressRoute gateways, NAT, and peering to spokes. This follows Azure =hub-and-spoke= best practices. 

** Key security and operational choices
1. *Hub-and-spoke networking* — centralizes security, simplifies routing and egress, isolates workloads.
2. *Azure Firewall + NSGs* — firewall for east-west and perimeter rules; NSGs for subnet-level micro-segmentation. Use firewall for inspection and NSGs for fast path filtering. Azure docs/tech guidance confirm this pattern. 
3. *Managed DB with private access* — keep DBs off public internet and restrict access from app subnets only. (The example module configures firewall rules and disables public access.)
4. *Remote state + locking* — store Terraform state in an Azure Storage Account container with blob locking or use Terraform Cloud. Avoid local state for teams.
5. *Modules & standard structure* — keep reusable modules (network, security, compute, db) to make environments (dev/staging/prod) easy to manage and test.


* Quickstart
#+begin_src shell
terraform init

terraform plan -var-file=environments/dev.tfvars

terraform apply -var-file=environments/dev.tfvars
#+end_src


* Roadmap WIP
- [ ] Add CI pipeline
- [ ] =modules/appgw/= for Application Gateway + WAF module
- [ ] =modules/aks/= if using containers (AKS + managed identities)
- [ ] =modules/monitoring/= for Log Analytics workspace, diagnostic settings, alerts
